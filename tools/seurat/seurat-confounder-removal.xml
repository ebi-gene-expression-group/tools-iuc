<tool id="seurat-confounder-removal" name="Seurat confounding factors removal" version="0.1.0">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-confounder-removal.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-confounder-removal.R'

    --data '$data_seurat'
    --vars $adv.vars
    --rds '$out_rds'

]]></command>

    <inputs>
        <param name="data_seurat" type="data" format="rdata" label="Seurat object" help="The input should be a Seurat object"/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <param name="vars" type="select" display="checkboxes" multiple="true" label="What variable (source of variation) do you want to remove ?">
                <option value="nGene">Number of detected genes</option>
                <option value="nUMI">Library size (UMI counts)</option>
                <option value="percent.mito">Percentage of mitochondrial gene expression</option>
            </param>
        </section>
    </inputs>

    <outputs>
        <data name="out_rscript" format="txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_seurat" ftype="rdata" value="out-feature-selection.rds"/>
            <param name="vars" value="nGene,nUMI"/>
            <output name="out_rds" ftype="rdata" value="out-multiple-conf-removal.rds" compare="sim_size"/>
        </test>
        <test>
            <param name="data_seurat" ftype="rdata" value="out-feature-selection.rds"/>
            <param name="vars" value="nUMI"/>
            <output name="out_rds" ftype="rdata" value="out-conf-removal.rds" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

You can also want to remove a source of variation like UMI counts and regress this signal. Seurat-confounder-removal 
predicts the gene expression based on UMI counts by generating a linear model. A new slot will be added in the
seurat object called scale.data to store the corresponding scaled z-scores. This slot will be used by dimensional
reduction and clustering methods used by Seurat.

-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
