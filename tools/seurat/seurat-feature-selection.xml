<tool id="seurat-feature-selection" name="Seurat feature selection" version="2.3.4">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="2.18.0">r-gdata</requirement>
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-feature-selection.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-feature-selection.R'

    --data '$data_rds'
    --x.low.cutoff $adv.x_low_cutoff
    --x.high.cutoff $adv.x_high_cutoff
    --y.cutoff $adv.y_cutoff
    --selection.method $adv.method.feature_selection
    #if $adv.method.feature_selection == "dispersion":
        --top.genes $adv.method.top_genes
    #end if
    --rds '$out_rds'
    --pdf '$out_pdf'

]]></command>

    <inputs>
        <param name="data_rds" type="data" format="rdata" label="Seurat object" help="The should be a Rdata file of a single Seurat object"/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <param argument="--x_low_cutoff" type="float" value="0.1" label="Bottom cutoff for average expression to identify variable genes" />
            <param argument="--x_high_cutoff" type="float" value="8" label="Top cutoff for average expression to identify variable genes" />
            <param argument="--y_cutoff" type="float" value="1" label="Bottom cutoff of Dispersion score for identifying variable genes" />
            <conditional name="method">
                <param name="feature_selection" type="select" display="radio" multiple="false" label="What method do you want to use for your feature selection ?">
                    <option value="mean.var.plot" selected="true">With the help of the above cutoffs</option>
                    <option value="dispersion">Based on the dispersion score</option>
                </param>
                <when value="mean.var.plot">
                </when>
                <when value="dispersion">
                    <param argument="--top_genes" type="float" value="1000"  label="How many genes do you want to keep ?" />
                </when>
             </conditional>
        </section>
    </inputs>

    <outputs>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: Plots" />
        <data name="out_rscript" format="txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_rds" ftype="rdata" value="out-normalization.rds"/>
            <param name="x_low_cutoff" value="0.0125" />
            <param name="x_high_cutoff" value="3" />
            <param name="y_cutoff" value="0.5" />
            <param name="feature_selection" value="mean.var.plot" />
            <output name="out_pdf" ftype="pdf" value="out-feature-selection.pdf" compare="sim_size"/>
            <output name="out_rds" ftype="rdata" value="out-feature-selection.rds" compare="sim_size"/>
        </test>
        <test>
            <param name="data_rds" ftype="rdata" value="out-normalization.rds"/>
            <param name="feature_selection" value="dispersion" />
            <output name="out_pdf" ftype="pdf" value="out-default-feature-selection.pdf" compare="sim_size"/>
            <output name="out_rds" ftype="rdata" value="out-default-feature-selection.rds" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

Seurat-feature-selection finds the most variable genes in your data. By looking into the relationship between
the dispersion and the average expression, it creates a new slot called var.genes with a vector of selected
features based on user-defined parameters. This slot can be used by the dimensional reduction by Seurat.

There is two ways of find variable genes :
    * Based on both dispersion and average expression :
        * Keeps all genes with a average expression between bottom and top cutoff in the average expression (--x_low_cutoff and --x_high_cutoff options)
        * Keeps all genes with a dispersion superior to the other cutoff, --y_cutoff option
    * Based on the top higher dispersion score :
        * Keeps all genes with the higher dispersion score, the number of kept genes depends on the option --top.genes

-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * PDF of plots
        * Dispersion plot, the 3 cutoffs determine whether the gene name will be plotted or not but it not corresponding to the list of variable genes if you choose the dispersion method.
    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
