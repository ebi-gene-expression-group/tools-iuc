<tool id="seurat-normalization" name="Seurat normalization" version="0.1.0">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-normalization.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-normalization.R'

    --data '$data_seurat'
    #if $adv.scale.median == "FALSE":
        --scale $adv.scale.size_factor
    #end if
    --rds '$out_rds'

]]></command>

    <inputs>
        <param name="data_seurat" type="data" format="rdata" label="Seurat object" help="The input should be a Seurat object"/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <conditional name="scale">
                <param name="median" type="select" label="Do you want to use the median of UMI as scale factor for the normalization ?">
                    <option value="FALSE">No</option>
                    <option value="TRUE" selected="true">Yes</option>
                </param>
                <when value="TRUE">
                </when>
                <when value="FALSE">
                    <param name="size_factor" type="float" value="10000" label="What scale factor do you want to use instead ?"/>
                </when>
            </conditional>
        </section>
    </inputs>

    <outputs>
        <data name="out_rscript" format="txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_seurat" ftype="rdata" value="out-filtering.rds"/>
            <param name="median" value="TRUE"/>
            <output name="out_rds" ftype="rdata" value="out-default-normalization.rds" compare="sim_size"/>
        </test>
        <test>
            <param name="data_seurat" ftype="rdata" value="out-filtering.rds"/>
            <param name="median" value="FALSE"/>
            <param name="size_factor" value="10000"/>
            <output name="out_rds" ftype="rdata" value="out-normalization.rds" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

Seurat-normalization provides global scaling for cell-level normalization. By supposing that there is 
the same RNA content across cells, it normalizes by the total expression then multiply by a user-defined 
scale factor to finally log2-transformed the data.

There are two ways to define your scale factor :
    * Choose median : median of UMI count is used as scale factor
    * Choose other : scale factor is a float where the default is 10,000

-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
