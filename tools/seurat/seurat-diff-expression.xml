<tool id="seurat-diff-expression" name="Seurat differential expression" version="0.1.0">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="2.18.0">r-gdata</requirement>
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-diff-expression.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-diff-expression.R'

    --data '$data_rds'     
    --min.pct $adv.min_pct
    --logfc.threshold $adv.logFC
    --rds '$out_rds'
    --tab '$out_tab'
    --pdf '$out_pdf'

]]></command>

    <inputs>
        <param name="data_rds" type="data" format="rdata" label="Seurat object" help="This should be a RDS file of a single Seurat object."/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <param name="min_pct" value="0.1" type="float" label="Minimum fraction of cell detection" help="All genes tested are expressed in at least this fraction of cells. Skip genes that are fewly expressed."/>
            <param name="logFC" type="float" value="0.25" label="Log(Fold Change) threshold" help="Keeps all genes that are diffentially expressed with a log(FC) superior to X."/>
        </section>
    </inputs>
    <outputs>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: Plots" />
        <data name="out_rscript" format="txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" label="${tool.name} on ${on_string}: RData file"/>
        <data name="out_tab" format="tsv" label="${tool.name} on ${on_string}: Tabular file"/>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_rds" ftype="rdata" value="out-clustering.rds"/>
            <param name="min_pct" value="0.25" />
            <param name="logFC" value="0.25" />
            <output name="out_rds" ftype="rdata" value="out-diff-expression.rds" compare="sim_size"/>
            <output name="out_pdf" ftype="pdf" value="out-diff-expression.pdf" compare="sim_size"/>
            <output name="out_tab" ftype="tsv" value="out-diff-expression.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

Seurat differential expression find differentially expressed genes for each cells clusters by testing a
cluster against the other cells. This tool needs that your Seurat object (input file) has already determine
clusters. It uses a wilcoxon test to identify markers differentially expressed. 


-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * PDF of plots
        * Heamap of top10 differentially expressed genes by clusters (rows) and cells grouped by cluster (columns)
        * Feature plots of the most differentially expressed genes for each cluster.
            * Visualize gene expression on a tSNE or PCA plot 
            * If you have a t-SNE in reduction slot in your dataset, il will plot cells in the two tSNE dimensions otherwise, it will take the first two PCs of the PCA slot

    * Seurat RDS object (can use within R)

    * TSV (Tabular Separated Value) file of the differential expression analysis. There are several columns :
        * p_val : p-value (
        * avg_logFC : average log(FC)
        * pct.1 : Fraction of cells where the gene is expressed in the cluster (see 6th column)
        * pct.2 :  Fraction of cells where the gene is expressed in other cells
        * p_val_adj : adjusted p-value
        * cluster : cluster of origin
        * gene : gene name

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
