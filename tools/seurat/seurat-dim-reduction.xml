<tool id="seurat-dim-reduction" name="Seurat dimensional reduction" version="0.1.0">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="2.18.0">r-gdata</requirement>
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-dim-reduction.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-dim-reduction.R'

    --data '$data_rds'     
    --numPCs $adv.pca.num_PCs

    #if $adv.pca.cells_use:
        --cells.use $adv.pca.cells_use
    #end if
    
    #if $adv.pca.col_groups:
        --col.pca $adv.pca.col_groups
    #end if

    --do.tsne $adv.tsne.do_tsne

    #if $adv.tsne.do_tsne == "TRUE":
        --numPCs.tsne $adv.tsne.num_PCs_tsne

        #if $adv.tsne.col_groups_tsne:
            --col.tsne $adv.tsne.col_groups_tsne
        #end if

    #end if

    --rds '$out_rds'
    --pdf '$out_pdf'

]]></command>

    <inputs>
        <param name="data_rds" type="data" format="rdata" label="Seurat object" help="This should be a RDS file of a single Seurat object."/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <section name="pca" title="Parameters for Principal Component Analysis" expanded="true">
                  <param name="num_PCs" type="integer" min="1" value="10" label="Number of PCs to use in plots" help="Uses this number of PCs in PCHEatmap, JackStrawPlot, FindClusters, RunTSNE. Default: 10"/>
                  <param name="cells_use" type="integer" min="0" optional="True" label="Cells to use for PCHeatmap" 
                          help="Plots this number of top ‘extreme’ cells on both ends of the spectrum, which dramatically speeds plotting for large datasets. If you let this parameter empty it will take all cells by default."/>
                  <param name="col_groups" type="text" optional="true" label="Which variable do you want to use for identify the different cells in your dataset ?"
                          help="The variable must be a column from the metadata slot of the seurat object (object@meta.data in R). If you let this parameter empty it will use the same color for all cells. Please refer to the help section for more information."/>
            </section>
                <conditional name="tsne">
                   <param name="do_tsne"  type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Perform t-SNE"/>
                   <when value="FALSE">
                   </when>
                   <when value="TRUE">
                      <param name="num_PCs_tsne" type="integer" min="1" value="10" label="Number of PCs to use in plots" help="Uses this number of PCs in PCHEatmap, JackStrawPlot, FindClusters, RunTSNE. Default: 10" />
                      <param name="col_groups_tsne" type="text" optional="true" label="Which variable do you want to use for identify the different cells in your dataset ?"
                          help="The variable must be a column from the metadata slot of the seurat object (object@meta.data in R). If you let this parameter empty it will use the same color for all cells. Please refer to the help section for more information."/>
                   </when>
                </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="out_pdf" format="pdf" from_work_dir="out.pdf" label="${tool.name} on ${on_string}: Plots" />
        <data name="out_rscript" format="txt" from_work_dir="out_rscript.txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" from_work_dir="Seurat.rds" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_rds" ftype="rdata" value="out-conf-removal.rds"/>
            <param name="numPCs" value="10" />
            <param name="cells_use" value="500"/>
            <param name="numPCs_tsne" value="10" />
            <param name="do_tsne" value="TRUE" />
            <output name="out_rds" ftype="rdata" value="out-dim-red.rds" compare="sim_size"/>
            <output name="out_pdf" ftype="pdf" value="out-dim-red.pdf" compare="sim_size"/>
        </test>
        <test>
            <param name="data_rds" ftype="rdata" value="out-conf-removal.rds"/>
            <param name="numPCs" value="10" />
            <param name="do_tsne" value="FALSE" />
            <output name="out_rds" ftype="rdata" value="out-default-dim-red.rds" compare="sim_size"/>
            <output name="out_pdf" ftype="pdf" value="out-default-dim-red.pdf" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.


Seurat dimensional reduction perform a Principal Component Analysis (PCA) and if wanted a t-SNE as well.

You can tweak your PCA thank to several parameters :
    * The number of principal component you want to study (default 10) 
    * The number of cells used for vizualize the heterogeneity in each PC, if you let this parameter blank it will take all the cells.
    * You can also decide to colored your cells based on a variable.
        * It takes any variable from your metadata slot. If you don't know what kind of metadata is available :
            * Open R
            * load("path/to/file.rdata") #load your Seurat object from the rdata file downloaded from Galaxy
            * colnames(seuset@meta.data) #gives you the list of metadata variable
        * The default colored all cells with the same color : the name of this variable in R object is "orig.ident"

If you decide to perform a t-SNE there will be two parameters:
   * The number of PC used as input features for dimensionality reduction
   * You can also choose how to color your cells : work the same as PCA color parameter

-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * PDF of plots
        * Plot(s) of top genes associated with the n principal components
        * PCA plot of the two first PCs
        * Heatmap for each principal components of 30 rows (genes associated with the PC) where columns correspond to cells in your data
        * QQ-plot for each PCs of the distribution of p-values for all genes compared with a uniform distribution (black dotted line).
        * Screeplot of the standard deviation of PCs
        * Additional plot if you decide to perform a t-SNE : t-SNE plot

    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
