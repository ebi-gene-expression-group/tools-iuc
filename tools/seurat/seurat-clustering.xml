<tool id="seurat-clustering" name="Seurat clustering" version="0.1.0">
    <description>for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="2.18.0">r-gdata</requirement>
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-clustering.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-clustering.R'

    --data '$data_rds'     
    --numPCs $adv.numPCs
    --resolution $adv.resolution
    --rds '$out_rds'
    --pdf '$out_pdf'

]]></command>

    <inputs>
        <param name="data_rds" type="data" format="rdata" label="Seurat object" help="This should be a RDS file of a single Seurat object."/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <param name="resolution" value="1" type="float" label="Resolution used to distinguish the different clusters" help="Use a value above 1.0 if you wnat a larger number of clusters"/>
            <param name="numPCs" type="integer" min="1" value="10" label="Number of PCs (dimensions) used for finding clusters"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_pdf" format="pdf" from_work_dir="out.pdf" label="${tool.name} on ${on_string}: Plots" />
        <data name="out_rscript" format="txt" from_work_dir="out_rscript.txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" from_work_dir="Seurat.rds" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="data_rds" ftype="rdata" value="out-dim-red.rds"/>
            <param name="numPCs" value="10" />
            <param name="resolution" value="1" />
            <output name="out_rds" ftype="rdata" value="out-clustering.rds" compare="sim_size"/>
            <output name="out_pdf" ftype="pdf" value="out-clustering.pdf" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

Seurat clustering use SNN method to determine different clusters in your dataset. In order to construct a
SNN graph, you must have perform a PCA before launch this tool (you can use Seurat dimensional reduction).
It will search k (30) nearest neighbors for each cells and link cells to each other if they shared the
same neighbors. You can modulate the resolution in order to get larger (resolution superior to 1) or smaller
(inferior to 1) clusters.

-----

**Inputs**

    * An object of class seurat stored in a RDS/RData file

-----

**Outputs**

    * PDF of plots
        * Based on the available reduction slot in your dataset
            * PCA plot of the two first PCs
            * t-SNE plot (optional)

    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
