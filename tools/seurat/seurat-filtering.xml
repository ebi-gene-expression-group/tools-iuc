<tool id="seurat-filtering" name="Seurat filtering" version="0.1.0">
    <description>- for single-cell RNA-seq data</description>
    <requirements>
        <requirement type="package" version="3.4.1">r-base</requirement>
        <requirement type="package" version="2.3.4">r-seurat</requirement>
        <requirement type="package" version="1.0.0">bioconductor-singlecellexperiment</requirement> 
        <requirement type="package" version="1.6.0">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", seurat version" $(R --vanilla --slave -e "library(seurat); cat(sessionInfo()\$otherPkgs\$seurat\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", SingleCellExperiment version" $(R --vanilla --slave -e "library(SingleCellExperiment); cat(sessionInfo()\$otherPkgs\$SingleCellExperiment\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $rscript:
    cp '$__tool_directory__/seurat-filtering.R' '$out_rscript' &&
#end if

Rscript '$__tool_directory__/seurat-filtering.R'

    --counts $counts
    --min.cells $adv.min_cells
    --min.genes $adv.min_genes

    #if $adv.umi.low_thresholds:
        --low.thresholds $adv.umi.low_thresholds
    #end if
    #if $adv.umi.high_thresholds:
        --high.thresholds $adv.umi.high_thresholds
    #end if
    --rds $out_rds
    --pdf $out_pdf

]]></command>

    <inputs>
        <param name="counts" type="data" format="tabular" label="Counts file" help="The should be a TAB-separated count matrix with gene identifers in the first column and a header row"/>
        <param name="rscript" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used by this tool will be provided as a text file in the output. Default: No" />
        <section name="adv" title="Advanced Options">
            <param argument="--min_cells" type="integer" min="0" value="0" label="Minimum cells" help="Include genes with detected expression in at least this many cells." />
            <param argument="--min_genes" type="integer" min="0"  value="0" label="Minimum genes" help="Include cells where at least this many genes are detected." />
            <section name="umi" title="Filter cells based on UMI ?">    
                <param argument="--low_thresholds" type="float" optional="True" label="Low threshold for filtering cells based on UMI counts" />
                <param argument="--high_thresholds" type="float" optional="True" label="High threshold for filtering cells based on UMI counts" />
            </section>
        </section>
    </inputs>

    <outputs>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: Plots" />
        <data name="out_rscript" format="txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>rscript</filter>
        </data>
        <data name="out_rds" format="rdata" label="${tool.name} on ${on_string}: RData file">
        </data>
    </outputs>

    <tests>
        <!-- Ensure count matrix input works -->
        <test>
            <param name="counts" ftype="tabular" value="deng_small.tab.gz"/>
            <param name="min_cells" value="3"/>
            <param name="min_genes" value="200"/>
            <param name="low_thresholds" value="1" />
            <param name="high_thresholds" value="20000000" />
            <output name="out_pdf" ftype="pdf" value="out-filtering.pdf" compare="sim_size"/>
            <output name="out_rds" ftype="rdata" value="out-filtering.rds" compare="sim_size"/>
        </test>
        <test>
            <param name="counts" ftype="tabular" value="deng_small.tab.gz"/>
            <output name="out_pdf" ftype="pdf" value="out-default-filtering.pdf" compare="sim_size"/>
            <output name="out_rds" ftype="rdata" value="out-default-filtering.rds" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Seurat_ is a toolkit for quality control, analysis, and exploration of single cell RNA sequencing data.
It is developed and maintained by the `Satija Lab`_ at NYGC. Seurat aims to enable users to identify and
interpret sources of heterogeneity from single cell transcriptomic measurements, and to integrate diverse
types of single cell data. See the `Seurat Guided Clustering tutorial`_ for more information.

Seurat-filtering will filtered out your expression data based on different method. By default, it keeps all rows (genes) and columns (cells).

In the advanced options, you can set several parameters :
    * Minimum cells : All genes that aren't detected in at least n cells will be filtered out
    * Minimum genes : All cells that don't detected at least n genes will be filtered out

If you also want to filter cells based on their UMI counts :
    * Low threshold : You will removed out all cells that have UMI counts below this threshold 
    * High threshold : You will removed all cells that have UMI counts over this threshold

-----

**Inputs**

    * Gene count matrix in TAB-separated format
        * First line is cell identifiers
        * First column is gene names

-----

**Outputs**

    * PDF of plots
        * Violin plots of the number of genes and UMI counts
        * Relationship between UMI counts and number of genes, if you choose to filter also cells based on UMI you will visualize red dotted lines corresponding to chosen thresholds

    * Seurat RDS object (can use within R)

Optionally you can choose to output

    * Rscript

.. _Seurat: https://www.nature.com/articles/nbt.4096
.. _Satija Lab: https://satijalab.org/seurat/
.. _Seurat Guided Clustering tutorial: https://satijalab.org/seurat/pbmc3k_tutorial.html

]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.4096</citation>
    </citations>
</tool>
